name: CI

on:
  push:
    branches:
      - main
      - v[0-9]+
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*
  pull_request:

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  # Due to limit of number of MacOS, run first.
  build:
    name: Build
    strategy:
      matrix:
        os: ['ubuntu-latest', 'macos-latest']
    uses: ./.github/workflows/ci-build.yml
    with:
      os: ${{ matrix.os }}
  lint:
    name: Lint
    needs: [build]
    uses: ./.github/workflows/ci-lint.yml

  unit:
    name: Unit
    needs: [build, lint]
    uses: ./.github/workflows/ci-unit.yml

  # Due to low performance, execute separately
  build-win:
    name: Build (windows-latest)
    needs: [build, lint]
    uses: ./.github/workflows/ci-build.yml
    with:
      os: 'windows-latest'

  e2e:
    name: E2E (${{ matrix.os }})
    needs: [build]
    strategy:
      matrix:
        os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
        scenario: ['builder', 'forge', 'no-binary']
        type: ['esm', 'cjs', '*']
        exclude:
          # E2E on the Linux/Mac runs as scenario-by-scenario (excludes specific type).
          - os: 'ubuntu-latest'
            type: 'esm'
          - os: 'ubuntu-latest'
            type: 'cjs'
          - os: 'macos-latest'
            type: 'esm'
          - os: 'macos-latest'
            type: 'cjs'
          # Due to limitation of number of parallel job on MacOS, execute custom unit. (exclude forge and no-binary)
          # https://docs.github.com/en/actions/administering-github-actions/usage-limits-billing-and-administration#usage-limits
          - os: 'macos-latest'
            scenario: 'forge'
          - os: 'macos-latest'
            scenario: 'no-binary'
          # E2E on the Windows runs as type-by-type (excludes wildcard type).
          - os: 'windows-latest'
            type: '*'
        include:
          # Due to limitation of number of parallel job on MacOS, add custom unit.
          - os: 'macos-latest'
            scenario: 'no-binary, forge'
            type: '*'
    uses: ./.github/workflows/ci-e2e.yml
    with:
      os: ${{ matrix.os }}
      node-version: '20'
      scenario: ${{ matrix.scenario }}
      type: ${{ matrix.type }}

  e2e-mac-universal:
    name: E2E for Mac Universal
    needs: [build]
    strategy:
      matrix:
        scenario: ['forge', 'builder']
        type: ['esm', 'cjs', '*']
        exclude:
          #  Forge E2E runs as scenario-by-scenario (excludes specific type).
          - scenario: 'forge'
            type: 'esm'
          - scenario: 'forge'
            type: 'cjs'
          #  Bundler E2E runs as type-by-type (excludes wildcard type).
          - scenario: 'builder'
            type: '*'
    uses: ./.github/workflows/ci-e2e.yml
    with:
      os: 'macos-latest'
      node-version: '20'
      build-command: 'build:mac-universal'
      scenario: ${{ matrix.scenario }}
      type: ${{ matrix.type }}
