name: Upload Compressed Artifacts
description: Compresses and uploads artifacts with caching for faster workflow access

inputs:
  paths:
    description: 'Path(s) to upload'
    required: true
  output:
    description: 'Output directory for the compressed file'
    required: false
    default: './dist'
  name:
    description: 'Name of the artifact'
    required: true
  cache_key_prefix:
    description: 'Prefix for cache key'
    required: false
    default: 'artifacts'
  retention_days:
    description: 'Number of days to keep artifacts'
    required: false
    default: '1'
  custom_cache_key:
    description: 'Custom cache key to use instead of auto-generated'
    required: false
  use_cache:
    description: 'Whether to use cache'
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    # Generate standard cache keys
    - name: 🔑 Generate Cache Keys
      id: generate-keys
      shell: bash
      run: |
        # Ensure cache key prefix has a value
        CACHE_PREFIX="${{ inputs.cache_key_prefix || 'artifacts' }}"
        NAME="${{ inputs.name }}"
        OS="${{ runner.os }}"
        RUN_ID="${{ github.run_id }}"

        # If a custom key is provided, use that
        if [ -n "${{ inputs.custom_cache_key }}" ]; then
          echo "standard_key=${{ inputs.custom_cache_key }}" >> $GITHUB_OUTPUT
          echo "::notice::Using custom cache key: ${{ inputs.custom_cache_key }}"
        else
          # Generate a standard cache key - format matches download-archive
          STANDARD_KEY="${OS}-${CACHE_PREFIX}-${NAME}-${RUN_ID}"
          echo "standard_key=${STANDARD_KEY}" >> $GITHUB_OUTPUT
          echo "::notice::Generated standard cache key: ${STANDARD_KEY}"

          # Generate OS-agnostic key for cross-platform compatibility
          AGNOSTIC_KEY="${CACHE_PREFIX}-${NAME}-${RUN_ID}"
          echo "agnostic_key=${AGNOSTIC_KEY}" >> $GITHUB_OUTPUT
          echo "::notice::Generated OS-agnostic key: ${AGNOSTIC_KEY}"
        fi

    # Create the archive
    - name: 📦 Create Archive
      id: create-archive
      shell: bash
      run: |
        # Create output directory if it doesn't exist
        mkdir -p "${{ inputs.output }}"

        # Create the zip file
        FILENAME="${{ inputs.name }}.zip"
        echo "Compressing ${{ inputs.paths }} to ${{ inputs.output }}/${FILENAME}"

        # Use zip to create the archive
        cd "${{ github.workspace }}" && zip -r "${{ inputs.output }}/${FILENAME}" ${{ inputs.paths }}

        # Check if the file was created
        if [ -f "${{ inputs.output }}/${FILENAME}" ]; then
          FILE_SIZE=$(stat -c%s "${{ inputs.output }}/${FILENAME}" 2>/dev/null || stat -f%z "${{ inputs.output }}/${FILENAME}" 2>/dev/null || ls -l "${{ inputs.output }}/${FILENAME}" | awk '{print $5}')
          echo "::notice::Created archive: ${{ inputs.output }}/${FILENAME} ($(du -h "${{ inputs.output }}/${FILENAME}" | cut -f1))"
          echo "filename=${FILENAME}" >> $GITHUB_OUTPUT
          echo "size=${FILE_SIZE}" >> $GITHUB_OUTPUT
        else
          echo "::error::Failed to create archive"
          exit 1
        fi

    # Save the archive to cache with OS-specific key
    - name: 🗄️ Cache Archive (OS-specific)
      id: cache-save
      if: inputs.use_cache != 'false'
      uses: actions/cache/save@v4
      with:
        path: ${{ inputs.output }}/${{ steps.create-archive.outputs.filename }}
        key: ${{ steps.generate-keys.outputs.standard_key }}

    # Save with OS-agnostic key for better cross-OS compatibility
    - name: 🗄️ Cache Archive (OS-agnostic)
      id: cache-save-agnostic
      if: inputs.use_cache != 'false'
      uses: actions/cache/save@v4
      with:
        path: ${{ inputs.output }}/${{ steps.create-archive.outputs.filename }}
        key: ${{ steps.generate-keys.outputs.agnostic_key }}

    # Save to standard artifact storage as fallback
    - name: 📤 Upload Artifact
      if: inputs.use_cache != 'true-only'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.name }}.zip
        path: ${{ inputs.output }}/${{ steps.create-archive.outputs.filename }}
        retention-days: ${{ inputs.retention_days }}
