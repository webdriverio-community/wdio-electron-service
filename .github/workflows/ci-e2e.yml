name: E2E Tests
description: 'Runs end-to-end tests across different scenarios and JavaScript module types'

on:
  workflow_call:
    # Make this a reusable workflow, no value needed
    # https://docs.github.com/en/actions/using-workflows/reusing-workflows
    inputs:
      os:
        description: 'Operating system to run tests on'
        required: true
        type: string
      node-version:
        description: 'Node.js version to use for testing'
        required: true
        type: string
      build-command:
        description: 'Build command for test applications (build or build:mac-universal)'
        type: string
        default: 'build'
      scenario:
        description: 'Test scenario (forge, builder, or no-binary)'
        required: true
        type: string
      type:
        description: 'JavaScript module type (esm, cjs, or * for both)'
        type: string
        default: '*'

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  e2e:
    name: E2E Tests - ${{ inputs.scenario }}${{ inputs.type != '*' && format(' ({0})',inputs.type) || '' }}
    runs-on: ${{ inputs.os }}
    strategy:
      fail-fast: false
    steps:
      - name: 👷 Checkout Repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: 🛠️ Setup Development Environment
        uses: ./.github/workflows/actions/setup-workspace
        with:
          node-version: ${{ inputs.node-version }}

      - name: 📦 Download Build Artifacts
        uses: ./.github/workflows/actions/download-archive
        with:
          name: wdio-electron-service
          path: .
          filename: wdio-electron-service-build.zip

      - name: 🔧 Apply Linux Kernel Workaround
        # https://github.com/electron/electron/issues/41066
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: sudo sysctl -q -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: 🪄 Generate Build Filter for Test Apps
        id: gen-build
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const generateBuildFilter = (scenario, type) => {
              return scenario
                .split(',')
                .map((s) => `--filter=example-${s.trim()}-${type}`)
                .join(' ');
            };
            return generateBuildFilter('${{ inputs.scenario }}', '${{ inputs.type }}');

      - name: 🏗️ Build Test Applications
        shell: bash
        run: pnpm exec turbo run ${{ inputs.build-command }} ${{ steps.gen-build.outputs.result }} --only --parallel

      - name: 🪄 Generate Test Execution Plan
        id: gen-test
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const generateTestCommand = (scenario, type) => {
              return scenario
                .split(',')
                .flatMap((s) => {
                  const scenario = s.trim();
                  return type === '*'
                    ? [`test:e2e:${scenario}-esm`, `test:e2e:${scenario}-cjs`]
                    : [`test:e2e:${scenario}-${type}`];
                })
                .join(' ');
            };
            return generateTestCommand('${{ inputs.scenario }}', '${{ inputs.type }}');

      - name: 🧪 Execute E2E Tests
        shell: bash
        run: pnpm exec turbo run init-e2es ${{ steps.gen-test.outputs.result }} --only

      - name: 🐛 Show Test Logs on Failure
        shell: bash
        if: failure()
        run: pnpm run ci:e2e:logs

      - name: 📦 Upload Test Logs on Failure
        uses: ./.github/workflows/actions/upload-archive
        if: failure()
        with:
          name: e2e-logs-${{ inputs.os }}${{ contains(inputs.build-command, 'mac-universal') && '-universal' || '' }}-${{ inputs.scenario }}${{ inputs.type != '*' && format('-{0}',inputs.type) || '' }}
          output: e2e-logs-${{ inputs.os }}${{ contains(inputs.build-command, 'mac-universal') && '-universal' || '' }}-${{ inputs.scenario }}${{ inputs.type != '*' && format('-{0}',inputs.type) || '' }}.zip
          paths: e2e/*/*.log

      - name: 🐛 Debug Build on Failure
        uses: stateful/vscode-server-action@v1.1.0
        if: failure()
        with:
          timeout: '180000'
